<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>SAD â€“ Assentamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- â”€â”€â”€ ESTILOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<style>
  /* scrollbar & fontes */
  html,body{overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none;height:100%;margin:0;padding:0;font-family:system-ui,Helvetica,Arial,sans-serif}
  html::-webkit-scrollbar,body::-webkit-scrollbar{width:0;height:0}

  body{background:#f8f9fa;padding:20px 0}
  img,canvas,svg{max-width:100%;height:auto}
  .custom-button{font-size:.8rem}

  /* botÃ£o carregar mapa */
  #map-load-btn-container{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(255,255,255,.8);z-index:1000}
  #load-map-btn{padding:12px 24px;font-size:1.2rem;box-shadow:0 4px 8px rgba(0,0,0,.2);background:linear-gradient(to bottom,#28a745,#1e7e34);border:none;color:#fff;border-radius:4px;transition:.3s}
  #load-map-btn:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.2)}

  /* mapa */
  .map-container{position:relative;height:450px;border-radius:8px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.1)}

  /* legenda gradiente */
  .heat-legend{position:absolute;right:10px;bottom:30px;z-index:1000;background:rgba(255,255,255,.85);padding:10px;border-radius:5px;box-shadow:0 2px 6px rgba(0,0,0,.2);width:120px;text-align:center}
  .heat-legend h4{margin:0 0 5px;font-size:.9rem;font-weight:bold;color:#333}
  .legend-gradient{height:150px;width:25px;margin:0 auto;border:1px solid #ddd;border-radius:3px}
  .legend-labels{display:flex;flex-direction:column;justify-content:space-between;height:150px;position:absolute;left:40px;top:40px;font-size:.8rem;color:#333}
  .legend-labels span{background:rgba(255,255,255,.7);padding:0 4px;border-radius:2px}

  /* cards */
  .card{border:none;border-radius:8px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.1)}
  .card-header{background:linear-gradient(to right,#2c7744,#28a745);color:#fff;font-weight:bold;padding:12px 15px}
  .card-body{padding:0}

  /* controles */
  .btn-success{background:linear-gradient(to bottom,#28a745,#1e7e34);border:none}
  .btn-success:hover{background:linear-gradient(to bottom,#218838,#1c7430)}
  .btn-info{background:linear-gradient(to bottom,#17a2b8,#138496);border:none}
  .btn-info:hover{background:linear-gradient(to bottom,#138496,#117a8b)}
  .form-select{border-radius:4px;border:1px solid #ced4da;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}

  /* responsivo */
  @media(max-width:768px){.card{margin-bottom:20px}.map-container{height:400px}}

  /* modal lista de assentamentos */
  .settlement-item{padding:8px 12px;border-bottom:1px solid #eee;transition:.2s}
  .settlement-item:hover{background:#f8f9fa;cursor:pointer}
  .settlement-item.selected{background:#e6f7ff;border-left:3px solid #1890ff}
  .selected-count{background:#28a745;color:#fff;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;margin-left:8px}
  .search-box{position:sticky;top:0;background:#fff;z-index:10;padding:10px 0}
  .settlement-list{max-height:300px;overflow-y:auto;margin-top:10px}
  .selection-info{margin-top:10px;font-size:.9rem;color:#6c757d}

  /* â€”â€”â€”â€”â€” ajuste da transparÃªncia da heat-legend â€”â€”â€”â€”â€” */
  .heat-legend{
    background: transparent !important;   /* remove o fundo branco */
    box-shadow: none !important;          /* remove a sombra */
  }
  /* opcional: mantÃ©m as etiquetas com leve fundo p/ leitura */
  .heat-legend .legend-labels span{
    background: rgba(255,255,255,.6);     /* meia-transparÃªncia */
  }


</style>

<!-- libs CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>

<body class="py-3">
<div class="container-fluid" id="app-root">

  <!-- botÃµes principais -->
  <div class="row mb-3 gy-2">
    <div class="col-auto"><button id="reset-btn" class="btn btn-success btn-sm custom-button"><i class="fa fa-filter me-1"></i>Remover Filtros</button></div>
    <div class="col-auto"><button id="state-btn" class="btn btn-success btn-sm custom-button" data-bs-toggle="modal" data-bs-target="#state-modal"><i class="fa fa-map me-1"></i>Selecione o Estado</button></div>
    <div class="col-auto"><button id="download-btn-open" class="btn btn-success btn-sm custom-button" data-bs-toggle="modal" data-bs-target="#download-modal"><i class="fa fa-download me-1"></i>Baixar CSV</button></div>
    <div class="col-auto"><button id="interest-btn" class="btn btn-info btn-sm custom-button" data-bs-toggle="modal" data-bs-target="#interest-modal"><i class="fa fa-star me-1"></i>Selecionar Ãrea de Interesse</button></div>
  </div>

  <!-- filtros -->
  <div class="row g-2 align-items-end mb-4">
    <div class="col-auto fw-bold">Ano:</div>
    <div class="col-6 col-md-3"><select id="year-select" class="form-select form-select-sm"></select></div>
    
  </div>

  <!-- barra + mapa -->
  <div class="row gx-2 mb-4">
    <div class="col-12 col-md-6 mb-4 mb-md-0">
      <div class="card h-100">
        <div class="card-header">SAD Alerta de DegradaÃ§Ã£o Florestal Acumulado Top 10</div>
        <div class="card-body p-0"><div id="bar-settlement" style="height:450px"></div></div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header" id="map-title">Mapa de DegradaÃ§Ã£o Ambiental (kmÂ²)</div>
        <div class="card-body p-0 map-container">
          <div id="map-graph" style="height:100%"></div>
          <div id="map-load-btn-container">
            <button id="load-map-btn" class="btn btn-success"><i class="fas fa-map me-2"></i>Carregar Mapa</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- sÃ©rie histÃ³rica + anual -->
  <div class="row gx-2 mb-5">
    <!-- sÃ©rie temporal -->
    <div class="col-12 col-md-6 mb-4 mb-md-0">
      <div class="card h-100">
        <div class="card-header">
          SAD de Alertas de DegradaÃ§Ã£o Florestal<br>Acumulado â€“ Assentamentos por Estado
        </div>
        <div class="card-body p-0"><div id="line-graph" style="height:450px"></div></div>
      </div>
    </div>

    <!-- grÃ¡fico anual -->
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">Ãrea Total de DegradaÃ§Ã£o por Ano (kmÂ²)</div>
        <div class="card-body p-0"><div id="yearly-graph" style="height:450px"></div></div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<!-- â”€â”€â”€ MODAIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- estados -->
<div class="modal fade" id="state-modal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Escolha os Estados</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><select id="state-select" class="form-select" multiple size="8"></select></div>
    <div class="modal-footer"><button class="btn btn-danger" data-bs-dismiss="modal">Fechar</button></div>
  </div></div>
</div>

<!-- download -->
<div class="modal fade" id="download-modal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">ConfiguraÃ§Ãµes de Download</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div id="download-state-checklist" class="mb-3"></div><hr>
      <div class="mb-2">
        <label class="me-2">Separador decimal</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="dec-sep" id="dec-dot" value="." checked>
          <label class="form-check-label" for="dec-dot">Ponto</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="dec-sep" id="dec-comma" value=",">
          <label class="form-check-label" for="dec-comma">VÃ­rgula</label>
        </div>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="remove-accents">
        <label class="form-check-label" for="remove-accents">Sem acentuaÃ§Ã£o</label>
      </div>
    </div>
    <div class="modal-footer">
      <button id="download-btn" class="btn btn-success me-2">Download</button>
      <button class="btn btn-danger" data-bs-dismiss="modal">Fechar</button>
    </div>
  </div></div>
</div>

<!-- Ã¡reas de interesse -->
<div class="modal fade" id="interest-modal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Selecionar Ãreas de Interesse</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="search-box"><input type="text" id="settlement-search" class="form-control" placeholder="Buscar assentamentoâ€¦"></div>
      <div class="selection-info"><span id="selected-count">0</span> selecionados</div>
      <div id="settlement-list" class="settlement-list"></div>
    </div>
    <div class="modal-footer">
      <button id="clear-selection" class="btn btn-outline-secondary">Limpar SeleÃ§Ã£o</button>
      <button id="apply-selection" class="btn btn-success">Aplicar SeleÃ§Ã£o</button>
    </div>
  </div></div>
</div>

<!-- libs JS -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- â”€â”€â”€ SCRIPT PRINCIPAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script type="module">
(async () => {
  /* â”€â”€â”€ constantes â”€â”€â”€ */
  const GEOJSON_URL = "/dataset/sad/geojson/AMZ_assentamentos.geojson";
  const CSV_URL     = "/dataset/sad/csv/alertas_sad_degradacao_09_2008_04_2024_assentamento.csv";
  const normUF      = s => (s||'').toString().toUpperCase();
  const CSV_UF_KEY  = 'ESTADO';
const BRAZIL_BOUNDS = L.latLngBounds(
  L.latLng(-34.0, -74.0),   // sudoeste
  L.latLng(  5.5, -34.0)    // nordeste
);
/* download */
const downloadBtn         = document.getElementById('download-btn');
const downloadStateBox    = document.getElementById('download-state-checklist');
const decSepRadioSelector = 'input[name="dec-sep"]:checked';
const removeAccentsChk    = document.getElementById('remove-accents');

  /* â”€â”€â”€ DOM â”€â”€â”€ */
  const stateBtn        = document.getElementById('state-btn');
  const stateSelect     = document.getElementById('state-select');
  const resetBtn        = document.getElementById('reset-btn');
  const yearSelect      = document.getElementById('year-select');
  
  const loadMapBtn      = document.getElementById('load-map-btn');
  const mapBtnContainer = document.getElementById('map-load-btn-container');
  const settlementList  = document.getElementById('settlement-list');
  const settlementSearch= document.getElementById('settlement-search');
  const selectedCount   = document.getElementById('selected-count');
  const clearSel        = document.getElementById('clear-selection');
  const applySel        = document.getElementById('apply-selection');

  /* â”€â”€â”€ estado global â”€â”€â”€ */
  let geojson, NAME_KEY='ASSENTAMEN';
  let df=[];
  let years=[], ufs=[], allSet=[];
  let selUF=[], selCat='', selSet=[];
  let curYear;
  let barSet=[];
  let mapInit=false, leafletMap, geoLayer, legend;

  /* â”€â”€â”€ carregamento â”€â”€â”€ */
  async function loadGeo(){ geojson = await (await fetch(GEOJSON_URL)).json(); }
  async function loadCsv(){
    const txt = await (await fetch(CSV_URL)).text();
    df = d3.csvParse(txt, d => ({
      ...d,
      ANO     : +d.ANO     || null,
      AREAKM2 : +d.AREAKM2 || 0,
      [CSV_UF_KEY]: normUF(d[CSV_UF_KEY])
    }));
  }

  /* â”€â”€â”€ filtros init â”€â”€â”€ */
  function buildFilters(){
    years=[...new Set(df.map(d=>d.ANO))].sort((a,b)=>a-b);
    curYear=Math.max(...years);
    yearSelect.innerHTML=years.map(y=>`<option>${y}</option>`).join('');
    yearSelect.value=curYear;

    /* categorias (se existirem) */


    /* UFs â€“ uniÃ£o CSV + GeoJSON */
    const geoUF=[...new Set(
      geojson.features
             .map(f=>normUF(f.properties.UF||f.properties.uf))
             .filter(Boolean)
    )];
    const csvUF=[...new Set(df.map(d=>d[CSV_UF_KEY]).filter(Boolean))];
    ufs=[...new Set([...geoUF,...csvUF])].sort();
    stateSelect.innerHTML=ufs.map(u=>`<option value="${u}">${u}</option>`).join('');

    /* assentamentos */
    allSet=[...new Set(df.map(d=>d.ASSENTAMEN))].sort();
    buildDownloadChecklist();   // ğŸ’¾ preenche modal de download

  }

  function updateStateBtn(){
    if(!selUF.length) stateBtn.innerHTML='<i class="fa fa-map me-1"></i>Selecione o Estado';
    else if(selUF.length===1) stateBtn.innerHTML=`<i class="fa fa-map me-1"></i>UF: ${selUF[0]}`;
    else stateBtn.innerHTML=`<i class="fa fa-map me-1"></i>${selUF.length} UFs`;
  }

  /* â”€â”€â”€ dataset filtrado (por ANO + seleÃ§Ãµes) â”€â”€â”€ */
  function base(){
    const y=+yearSelect.value;
    
    selUF=Array.from(stateSelect.selectedOptions).map(o=>o.value);
    updateStateBtn();
    let out=df.filter(d=>d.ANO===y)
              .filter(d=>!selUF.length||selUF.includes(d[CSV_UF_KEY]));
    if(selSet.length) out=out.filter(d=>selSet.includes(d.ASSENTAMEN));
    return out;
  }

  /* â”€â”€â”€ grÃ¡fico barra â”€â”€â”€ */
  function plotBar(){
    const data = base();
    const agg  = d3.rollup(data,
      v=>d3.sum(v,d=>d.AREAKM2),
      d=>d.ASSENTAMEN
    );
    let arr=[...agg].map(([ASSENTAMEN,area])=>({ASSENTAMEN,area}))
                    .sort((a,b)=>b.area-a.area);
    if(selSet.length) arr=arr.filter(d=>selSet.includes(d.ASSENTAMEN));
    else              arr=arr.slice(0,10);
    barSet=arr.map(d=>d.ASSENTAMEN);
    const leftMargin=Math.min(300,40+Math.max(...arr.map(d=>d.ASSENTAMEN.length))*6);
    Plotly.newPlot('bar-settlement',[{
      x:arr.map(d=>d.area),y:arr.map(d=>d.ASSENTAMEN),
      type:'bar',orientation:'h',
      marker:{color:'#28a745',opacity:.8,line:{color:'#1e7e34',width:1}}
    }],{
      title:{text:`Ãrea (${yearSelect.value}) â€“ ${selSet.length?'Selecionados':'Top 10'}`,x:.5},
      margin:{l:leftMargin,r:10,t:50,b:30},height:450,
      yaxis:{automargin:true},xaxis:{title:'Ãrea (kmÂ²)'},
      plot_bgcolor:'rgba(0,0,0,0)',paper_bgcolor:'rgba(0,0,0,0)'}
    ,{displayModeBar:false,responsive:true});
  }

  /* â”€â”€â”€ mapa â”€â”€â”€ */
  function initMap() {
  if (mapInit) return;

  leafletMap = L.map('map-graph', {
    zoomSnap: .30,
    attributionControl: false,
    maxBounds: BRAZIL_BOUNDS,        // â† trava dentro do Brasil
    maxBoundsViscosity: 1.0          // â€œpuxaâ€ de volta se tentar sair
  })
  .setView([-14, -55], 4);           // centro aproximado

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 18 }
  ).addTo(leafletMap);

  legend = L.DomUtil.create('div', 'heat-legend');
  legend.style.display = 'none';
  leafletMap.getContainer().appendChild(legend);

  mapInit = true;
}

  /* â”€â”€â”€ LEGEND (corrigido) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function heatLegend(min, max, scale) {
  legend.innerHTML = `
    <h4>Ãrea&nbsp;(kmÂ²)</h4>
    <div class="legend-gradient"></div>
    <div class="legend-labels">
      <span>${max.toLocaleString()}</span>
      <span>${((max + min) / 2).toLocaleString()}</span>
      <span>${min.toLocaleString()}</span>
    </div>`;

  /* agora o topo (100 %) recebe o valor MÃXIMO â†’ vermelho,
     e o rodapÃ© (0 %) recebe o valor MÃNIMO â†’ branco/amarelo */
  legend.querySelector('.legend-gradient').style.background =
    `linear-gradient(to top,
       ${scale(min)} 0%,
       ${scale((max + min) / 2)} 50%,
       ${scale(max)} 100%)`;

  legend.style.display = 'block';
}

  function plotMap(){
      document.getElementById('map-title').textContent =`Mapa de DegradaÃ§Ã£o Ambiental (kmÂ²) ${yearSelect.value}`;

    if(!mapInit) return;
    const data=base();
    const agg=d3.rollup(data,
      v=>d3.sum(v,d=>d.AREAKM2),
      d=>d[NAME_KEY]
    );
    const show=selSet.length?selSet:barSet;
    const maxArea=d3.max(show,a=>agg.get(a)||0)||1;
    const color=d3.scaleSequential().domain([0,maxArea]).interpolator(d3.interpolateYlOrRd);
    heatLegend(0,maxArea,color);
    if(geoLayer) geoLayer.remove();
    geoLayer=L.geoJSON(geojson,{
      coordsToLatLng:c=>L.latLng(c[1],c[0]),
      filter:f=>show.includes(f.properties[NAME_KEY]),
      style:f=>({
        weight:1.2,color:'#555',fillOpacity:.75,
        fillColor:color(agg.get(f.properties[NAME_KEY])||0)
      }),
      onEachFeature:(f,layer)=>{
        const nome=f.properties[NAME_KEY];
        const km2Csv=agg.get(nome);
        const haPoly=+f.properties.area_hecta ||0;
        const ha=km2Csv!==undefined?km2Csv*1000:haPoly;
        layer.bindTooltip(`<strong>${nome}</strong><br>${ha.toLocaleString('pt-BR',{maximumFractionDigits:2})} kmÂ²`,{sticky:true});
        layer.on({
          mouseover:e=>e.target.setStyle({weight:2,color:'#000'}).bringToFront(),
          mouseout:e=>geoLayer.resetStyle(e.target),
          click:e=>leafletMap.fitBounds(e.target.getBounds(),{maxZoom:10})
        });
      }
    }).addTo(leafletMap);
    if(geoLayer.getLayers().length){
      const b=geoLayer.getBounds();
      leafletMap.fitBounds(b);
      if(leafletMap.getZoom()>8) leafletMap.setZoom(8);
    }
  }

  /* â”€â”€â”€ sÃ©rie temporal â”€â”€â”€ */
  function plotLine(){
    const fil=df.filter(d=>
      (!selCat||d.categoria===selCat) &&
      (!selUF.length||selUF.includes(d[CSV_UF_KEY])) &&
      (!selSet.length||selSet.includes(d.ASSENTAMEN))
    );
    const by=d3.rollup(fil,
      v=>d3.sum(v,d=>d.AREAKM2),
      d=>d.ASSENTAMEN,
      d=>d.ANO
    );
    const pal=d3.schemeTableau10;
    const show=selSet.length?selSet:(barSet.length?barSet:[...by.keys()]);
    const series=show.map((s,i)=>{
      const mp=by.get(s); if(!mp) return null;
      const yrs=[...mp.keys()].sort((a,b)=>a-b);
      return{
        name:s,x:yrs,y:yrs.map(y=>mp.get(y)),
        mode:'lines+markers',
        line:{width:2,color:pal[i%pal.length]},
        marker:{size:8,color:pal[i%pal.length]}
      };
    }).filter(Boolean);
    Plotly.newPlot('line-graph',series,{
      title:{text:`SÃ©rie HistÃ³rica â€“ ${selCat||'Todas'}`,x:.5,font:{size:16}},
      xaxis:{title:'Ano'},yaxis:{title:'Ãrea (kmÂ²)'},
      legend:{orientation:'h',x:0.5,xanchor:'center',y:-.2,bgcolor:'rgba(255,255,255,.7)'},
      height:450,margin:{l:50,t:50,b:50,r:20},
      plot_bgcolor:'rgba(0,0,0,0)',paper_bgcolor:'rgba(0,0,0,0)'
    },{displayModeBar:false,responsive:true});
  }

  /* â”€â”€â”€ grÃ¡fico anual â”€â”€â”€ */
  function plotYearly(){
    const dat=df.filter(d=>
      (!selCat||d.categoria===selCat) &&
      (!selUF.length||selUF.includes(d[CSV_UF_KEY])) &&
      (!selSet.length||selSet.includes(d.ASSENTAMEN))
    );
    const agg=d3.rollup(dat,
      v=>d3.sum(v,d=>d.AREAKM2),
      d=>d.ANO
    );
    const anos=[...agg.keys()].sort((a,b)=>a-b);
    const val=anos.map(a=>agg.get(a)||0);
    Plotly.newPlot('yearly-graph',[{
      x:anos,y:val,type:'bar',
      marker:{color:'rgba(40,167,69,0.7)',line:{width:1,color:'#1e7e34'}},
      hovertemplate:'%{y:,.2f} kmÂ²<extra>%{x}</extra>'
    }],{
      title:{text:'Ãrea Total por Ano',x:.5},
      xaxis:{title:'Ano'},yaxis:{title:'Ãrea (kmÂ²)'},
      margin:{l:50,r:10,t:50,b:40},height:450,
      plot_bgcolor:'rgba(0,0,0,0)',paper_bgcolor:'rgba(0,0,0,0)'
    },{displayModeBar:false,responsive:true});
  }

  /* â”€â”€â”€ lista de assentamentos â”€â”€â”€ */
  function refreshList(){
    const term=(settlementSearch.value||'').toLowerCase();
    settlementList.innerHTML=allSet
      .filter(a=>a.toLowerCase().includes(term))
      .map(a=>`<div class="settlement-item ${selSet.includes(a)?'selected':''}" data-name="${a}">${a}</div>`)
      .join('');
    selectedCount.textContent=selSet.length;
    settlementList.querySelectorAll('.settlement-item').forEach(el=>{
      el.onclick=()=>{
        const n=el.dataset.name;
        const ix=selSet.indexOf(n);
        if(ix===-1) selSet.push(n); else selSet.splice(ix,1);
        refreshList();
      };
    });
  }

  /* ------------- cria a checklist de UFs para download ------------- */
function buildDownloadChecklist() {
  downloadStateBox.innerHTML = ufs.map(uf => `
    <div class="form-check form-check-inline mb-1">
      <input class="form-check-input dl-uf" type="checkbox" id="dl-${uf}" value="${uf}">
      <label class="form-check-label" for="dl-${uf}">${uf}</label>
    </div>
  `).join('');
}

/* remove acentos, se o usuÃ¡rio pedir */
function stripAccents(txt) {
  return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

/* converte objeto â†’ linha CSV; ponto-ou-vÃ­rgula para nÃºmeros */
function objToCsvRow(obj, headers, decSep, noAcc) {
  return headers.map(h => {
    let v = obj[h] ?? '';
    if (typeof v === 'string') v = noAcc ? stripAccents(v) : v;
    if (typeof v === 'number' && decSep === ',')
      v = v.toString().replace('.', ',');
    return `"${String(v).replace(/"/g, '""')}"`;   // escapa aspas
  }).join(';');                                    // separador de coluna
}

  /* â”€â”€â”€ eventos â”€â”€â”€ */
  [yearSelect,stateSelect].forEach(el=>
    el.onchange=()=>{plotBar();plotMap();plotLine();plotYearly();}
  );

  resetBtn.onclick=()=>{
    stateSelect.selectedIndex=-1; selUF=[];
    yearSelect.value=curYear; selSet=[];
    updateStateBtn();
    plotBar(); plotMap(); plotLine(); plotYearly();
  };

  loadMapBtn.onclick=()=>{initMap();plotMap();mapBtnContainer.style.display='none';};

  settlementSearch.oninput=refreshList;
  clearSel.onclick=()=>{selSet=[];refreshList();};
  applySel.onclick=()=>{
    bootstrap.Modal.getInstance(document.getElementById('interest-modal')).hide();
    plotBar(); plotMap(); plotLine(); plotYearly();
  };
  /* ------------------------- download CSV ------------------------- */
downloadBtn.onclick = () => {
  /* 1. quais UFs o usuÃ¡rio marcou?  (vazio = todas) */
  const selUFs = Array.from(document.querySelectorAll('.dl-uf:checked'))
                      .map(el => el.value);

  /* 2. opÃ§Ãµes do pop-up */
  const decSep = document.querySelector(decSepRadioSelector)?.value || '.';
  const noAcc  = removeAccentsChk.checked;

  /* 3. linhas filtradas */
  const rows = df.filter(d => !selUFs.length || selUFs.includes(d[CSV_UF_KEY]));

  if (!rows.length) {
    alert('Nenhum registro encontrado para as UFs selecionadas.');
    return;
  }

  /* 4. gera CSV */
  const headers = Object.keys(rows[0]);
  const csvLines = [
    headers.join(';'),
    ...rows.map(r => objToCsvRow(r, headers, decSep, noAcc))
  ].join('\n');

  /* 5. cria Blob e dispara download */
  const blob = new Blob([csvLines], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `alertas_degradacao_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
};


  /* â”€â”€â”€ inicializaÃ§Ã£o â”€â”€â”€ */
  try{
    await Promise.all([loadGeo(),loadCsv()]);

    /* identifica coluna de nome no GeoJSON */
    {
      const sample=geojson.features[0]?.properties||{};
      if(!('ASSENTAMEN' in sample)){
        if('NOME_PROJ2' in sample) NAME_KEY='NOME_PROJ2';
        else{
          const alt=Object.keys(sample).find(k=>k.toLowerCase().startsWith('nome'));
          if(alt) NAME_KEY=alt;
        }
      }
      console.log('Campo-nome usado no GeoJSON â†’',NAME_KEY);
    }

    /* garante campo NAME_KEY tambÃ©m no CSV (para filtros) */
    if(NAME_KEY!=='ASSENTAMEN'){
      df.forEach(d=>{ d[NAME_KEY]=d.ASSENTAMEN; });
    }

    buildFilters(); updateStateBtn(); refreshList();
    plotBar(); plotLine(); plotYearly();

  }catch(e){
    console.error(e);
    document.getElementById('app-root').insertAdjacentHTML(
      'afterbegin',`<div class="alert alert-danger">Erro: ${e.message}</div>`
    );
  }
})();
</script>
</body>
</html>
